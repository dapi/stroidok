# Спецификация команды /search для StroiDok

## Обзор

Команда `/search` предоставляет пользователям Claude Code возможность выполнять семантический поиск по индексированным документам в базе данных StroiDok. Команда интегрируется с MCP-сервером StroiMCP для обогащения контекста релевантными документами.

> **Терминология:** Все используемые термины определены в [`../glossary.md`](../glossary.md)

## Архитектура

```
Claude Code → /search команду → MCP Tool: search_documents → StroiMCP → PostgreSQL + pgvector
```

## Функциональные требования

### 1. Основная функциональность
- Семантический поиск по документам
- Полнотекстовый поиск
- Фильтрация по типам документов
- Сортировка по релевантности
- Пагинация результатов
- Возврат фрагментов контекста

### 2. Поддерживаемые типы поиска
- **Семантический поиск** - через векторные представления (pgvector)
- **Полнотекстовый поиск** - через PostgreSQL FTS (russian)
- **Гибридный поиск** - комбинация обоих подходов

## Параметры команды

### Синтаксис
```
/search [query] [options]
```

### Обязательные параметры
- `query` (string) - поисковый запрос на естественном языке

### Опциональные параметры
- `--limit, -l` (int, default: 10) - количество результатов
- `--types, -t` (string[]) - фильтр по типам документов
- `--date-from` (date) - начальная дата документов
- `--date-to` (date) - конечная дата документов
- `--source` (string) - источник/путь документа
- `--format, -f` (string) - формат вывода (text|json|markdown)
- `--context, -c` (boolean, default: true) - включать контекстные фрагменты
- `--chunks, -k` (int, default: 3) - количество фрагментов на документ

### Примеры использования
```
# Базовый поиск
/search "требования к пожарной безопасности"

# Поиск с фильтрацией
/search "бюджет проекта" --types=pdf,docx --limit=5

# Поиск с датами
/search "технические условия" --date-from=2024-01-01 --date-to=2024-12-31

# Поиск в формате JSON
/search "контракты с подрядчиками" --format=json --limit=3
```

## MCP Tool спецификация

### Инструмент: search_documents

```json
{
  "name": "search_documents",
  "description": "Выполняет семантический поиск по строительной документации",
  "parameters": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "Поисковый запрос на естественном языке",
        "minLength": 1,
        "maxLength": 500
      },
      "limit": {
        "type": "integer",
        "description": "Максимальное количество результатов",
        "minimum": 1,
        "maximum": 50,
        "default": 10
      },
      "document_types": {
        "type": "array",
        "items": {
          "type": "string"
        },
        "description": "Фильтр по типам документов (pdf, docx, xlsx, txt)",
        "default": []
      },
      "date_range": {
        "type": "object",
        "properties": {
          "from": {
            "type": "string",
            "format": "date"
          },
          "to": {
            "type": "string",
            "format": "date"
          }
        }
      },
      "source_filter": {
        "type": "string",
        "description": "Фильтр по пути к источнику документов"
      },
      "include_context": {
        "type": "boolean",
        "description": "Включать контекстные фрагменты документов",
        "default": true
      },
      "max_chunks": {
        "type": "integer",
        "description": "Максимальное количество фрагментов на документ",
        "minimum": 1,
        "maximum": 10,
        "default": 3
      },
      "search_mode": {
        "type": "string",
        "enum": ["semantic", "fulltext", "hybrid"],
        "description": "Режим поиска",
        "default": "hybrid"
      }
    },
    "required": ["query"]
  }
}
```

## Формат ответа

### Успешный ответ
```json
{
  "success": true,
  "query": "требования к пожарной безопасности",
  "total_results": 15,
  "search_time": "0.245s",
  "results": [
    {
      "id": "doc_12345",
      "title": "СП 4.13130.2013 Системы противопожарной защиты",
      "file_path": "/docs/standards/SP_4.13130.2013.pdf",
      "file_type": "pdf",
      "file_size": "2.4MB",
      "created_at": "2024-03-15T10:30:00Z",
      "updated_at": "2024-03-15T10:30:00Z",
      "relevance_score": 0.94,
      "highlights": [
        "Требования к пожарной безопасности для зданий и сооружений",
        "Системы автоматической пожарной сигнализации"
      ],
      "context_chunks": [
        {
          "chunk_index": 0,
          "text": "Здания должны быть оснащены автоматическими системами пожарной сигнализации в соответствии с требованиями...",
          "page_number": 15,
          "relevance_score": 0.91
        }
      ]
    }
  ],
  "facets": {
    "document_types": {
      "pdf": 12,
      "docx": 3
    },
    "date_distribution": {
      "2024-01": 5,
      "2024-02": 7,
      "2024-03": 3
    }
  },
  "suggestions": [
    "противопожарные системы",
    "нормы пожарной безопасности",
    "требования к эвакуации"
  ]
}
```

### Ошибочный ответ
```json
{
  "success": false,
  "error": {
    "code": "INVALID_QUERY",
    "message": "Поисковый запрос слишком короткий",
    "details": "Минимальная длина запроса: 3 символа"
  }
}
```

## Алгоритм работы

### 1. Валидация параметров
- Проверка обязательных параметров
- Валидация формата данных
- Проверка лимитов

### 2. Обработка запроса
- Нормализация поискового запроса
- Генерация векторного представления (для семантического поиска)
- Построение SQL запроса

### 3. Выполнение поиска
```
IF search_mode == "semantic" OR "hybrid":
    // Векторный поиск через pgvector
    SELECT d.*, e.embedding <=> query_embedding as distance
    FROM documents d
    JOIN document_embeddings e ON d.id = e.document_id
    WHERE filters_apply
    ORDER BY distance
    LIMIT limit * 2

IF search_mode == "fulltext" OR "hybrid":
    // Полнотекстовый поиск
    SELECT d.*, ts_rank(to_tsvector('russian', d.content), query) as rank
    FROM documents d
    WHERE to_tsvector('russian', d.content) @@ to_tsquery('russian', query)
    AND filters_apply
    ORDER BY rank DESC
    LIMIT limit * 2

IF search_mode == "hybrid":
    // Слияние и ранжирование результатов
    merged_results = merge_and_rerank(vector_results, fts_results)
```

### 4. Форматирование результатов
- Применение пагинации
- Извлечение контекстных фрагментов
- Генерация сниппетов и highlight
- Расчет фасетов и предложений

## Коды ошибок

| Код | Описание | Решение |
|-----|----------|---------|
| `INVALID_QUERY` | Некорректный поисковый запрос | Проверить синтаксис и длину запроса |
| `RATE_LIMIT` | Превышен лимит запросов | Повторить попытку позже |
| `INDEX_UNAVAILABLE` | Поисковый индекс недоступен | Проверить статус Stroidex |
| `DATABASE_ERROR` | Ошибка базы данных | Проверить подключение к БД |
| `UNAUTHORIZED` | Нет доступа к документам | Проверить права доступа |

## Интеграция с Claude Code

### Регистрация команды
```go
// .claude/commands/search.md
# Команда: /search
# Описание: Поиск по строительной документации
# Использование: /search [query] [options]

name: search
description: Поиск по индексированным документам Stroidok
usage: "/search [query] [options]"
examples:
  - "/search \"требования к пожарной безопасности\""
  - "/search \"бюджет\" --types=pdf,docx --limit=5"
```

### Контекстная интеграция
Claude Code автоматически определяет релевантность поиска когда пользователь:
- Упоминает документы, спецификации, требования
- Просит найти информацию в проектной документации
- Использует терминологию из строительной области

## Производительность

### Целевые метрики
- **Время ответа**: < 1 секунда для типичных запросов
- **Точность поиска**: > 85% релевантных результатов в топ-5
- **Поддерживаемый объем**: до 100K документов
- **Конкурентность**: до 100 одновременных поисковых запросов

### Оптимизации
- **Кэширование** популярных запросов в Redis (TTL: 5 минут)
- **Индексы** для полнотекстового поиска и фильтров
- **Предвычисленные эмбеддинги** для всех документов
- **Пул соединений** с базой данных

## Безопасность

### Ограничения доступа
- Поиск только по индексированным документам
- Фильтрация по правам доступа пользователя
- Логирование всех поисковых запросов
- Rate limiting для предотвращения abuse

### Валидация входных данных
- Санитизация поисковых запросов
- Проверка SQL injection
- Ограничение длины запросов
- Валидация параметров фильтрации

## Тестирование

### Unit тесты
- Валидация параметров команды
- Алгоритмы ранжирования
- Форматирование результатов

### Интеграционные тесты
- MCP Tool взаимодействие
- Поиск в различных режимах
- Фильтрация и сортировка

### Нагрузочные тесты
- Производительность при большом объеме данных
- Конкурентные запросы
- Время ответа под нагрузкой

## Мониторинг

### Метрики
- Количество поисковых запросов
- Среднее время ответа
- Точность поиска (через пользовательскую обратную связь)
- Популярные запросы

### Логирование
- Все поисковые запросы с параметрами
- Время выполнения запросов
- Ошибки поиска
- Статистика использования фильтров