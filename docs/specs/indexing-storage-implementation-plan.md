# План имплементации: Индексация и хранение документов

## Обзор
План имплементации компонента индексации и хранения документов для сохранения обработанных документов в базе данных PostgreSQL, создания индексов для поиска и обеспечения целостности данных.

## План имплементации

### 1. Настройка проекта и зависимостей

- [ ] 1.1 Установка зависимостей для работы с базой данных
  - [ ] 1.1.1 `github.com/lib/pq` - PostgreSQL драйвер
  - [ ] 1.1.2 `github.com/jmoiron/sqlx` - SQL расширения
  - [ ] 1.1.3 `github.com/golang-migrate/migrate/v4` - миграции базы данных
  - [ ] 1.1.4 `github.com/jackc/pgx/v5` - современный PostgreSQL драйвер
  - [ ] 1.1.5 `github.com/pgvector/pgvector` - векторные расширения
  - [ ] 1.1.6 `github.com/prometheus/client_golang` - метрики
  - [ ] 1.1.7 `github.com/spf13/viper` - конфигурация

- [ ] 1.2 Создание структуры проекта
  - [ ] 1.2.1 Создать `internal/storage/` директорию
  - [ ] 1.2.2 Создать `internal/storage/types.go` для типов и структур
  - [ ] 1.2.3 Создать `internal/storage/config.go` для конфигурации
  - [ ] 1.2.4 Создать `internal/storage/migrations/` для миграций БД
  - [ ] 1.2.5 Создать `internal/storage/queries/` для SQL запросов

### 2. Проектирование базы данных

- [ ] 2.1 Создание схемы базы данных
  - [ ] 2.1.1 Создать таблицу `documents` для хранения основных данных
  - [ ] 2.1.2 Создать таблицу `document_pages` для PDF страниц
  - [ ] 2.1.3 Создать таблицу `document_sheets` для XLSX листов
  - [ ] 2.1.4 Создать таблицу `processing_errors` для ошибок
  - [ ] 2.1.5 Создать таблицу `document_versions` для истории изменений

- [ ] 2.2 Создание индексов
  - [ ] 2.2.1 Полнотекстовый индекс `documents_content_fts` с поддержкой русского языка
  - [ ] 2.2.2 Индексы по метаданным (`documents_file_path_idx`, `documents_file_type_idx`)
  - [ ] 2.2.3 Временные индексы (`documents_modified_at_idx`)
  - [ ] 2.2.4 Индексы по статусу (`documents_status_idx`)
  - [ ] 2.2.5 Индекс по JSONB метаданным (`documents_metadata_idx`)

- [ ] 2.3 Миграции базы данных
  - [ ] 2.3.1 Создать `001_create_documents_table.up.sql`
  - [ ] 2.3.2 Создать `001_create_documents_table.down.sql`
  - [ ] 2.3.3 Создать `002_create_indexes.up.sql`
  - [ ] 2.3.4 Создать миграции для обновления схемы
  - [ ] 2.3.5 Создать скрипты для начального заполнения

### 3. Базовые структуры и интерфейсы

- [ ] 3.1 Основные структуры данных
  - [ ] 3.1.1 Создать `Document struct` для работы с документами
  - [ ] 3.1.2 Создать `SearchQuery struct` для поисковых запросов
  - [ ] 3.1.3 Создать `IndexerStatus struct` для статуса индексации
  - [ ] 3.1.4 Создать `ProcessingError struct` для ошибок

- [ ] 3.2 Интерфейсы
  - [ ] 3.2.1 Создать `Indexer interface` с основными методами (IndexDocument, UpdateDocument, DeleteDocument)
  - [ ] 3.2.2 Создать `Searcher interface` для поиска документов
  - [ ] 3.2.3 Создать `Repository interface` для работы с БД
  - [ ] 3.2.4 Создать `Migrator interface` для миграций

### 4. Реализация PostgresIndexer

- [ ] 4.1 Основная структура PostgresIndexer
  - [ ] 4.1.1 Создать `PostgresIndexer struct` с полями (db, batchSize, logger, metrics)
  - [ ] 4.1.2 Реализовать конструктор `NewPostgresIndexer(config *DatabaseConfig)`
  - [ ] 4.1.3 Реализовать подключение к базе данных
  - [ ] 4.1.4 Добавить пул соединений и его конфигурацию

- [ ] 4.2 Индексация документов
  - [ ] 4.2.1 Реализовать `IndexDocument(ctx context.Context, doc *Document)` метод
  - [ ] 4.2.2 Проверка на дубликаты по пути к файлу и хэшу
  - [ ] 4.2.3 Использование транзакций для целостности данных
  - [ ] 4.2.4 Пакетная индексация для производительности
  - [ ] 4.2.5 Обработка ошибок индексации

- [ ] 4.3 Обновление документов
  - [ ] 4.3.1 Реализовать `UpdateDocument(ctx context.Context, doc *Document)` метод
  - [ ] 4.3.2 Сохранение истории изменений
  - [ ] 4.3.3 Обновление связанных данных (страницы, листы)
  - [ ] 4.3.4 Обновление полнотекстового индекса

- [ ] 4.4 Удаление документов
  - [ ] 4.4.1 Реализовать `DeleteDocument(ctx context.Context, path string)` метод
  - [ ] 4.4.2 Каскадное удаление связанных данных
  - [ ] 4.4.3 Логирование удалений
  - [ ] 4.4.4 Soft delete для истории

### 5. Реализация поиска

- [ ] 5.1 Полнотекстовый поиск
  - [ ] 5.1.1 Реализовать поиск по текстовому содержимому с использованием `to_tsvector`
  - [ ] 5.1.2 Поддержка русского языка в полнотекстовом поиске
  - [ ] 5.1.3 Ранжирование результатов по релевантности
  - [ ] 5.1.4 Поддержка булевых операторов и фраз

- [ ] 5.2 Поиск по метаданным
  - [ ] 5.2.1 Поиск по JSONB метаданным с использованием `@>`
  - [ ] 5.2.2 Поиск по имени файла и типу
  - [ ] 5.2.3 Поиск по временным диапазонам
  - [ ] 5.2.4 Комбинированный поиск по нескольким полям

- [ ] 5.3 Advanced поиск
  - [ ] 5.3.1 Реализовать `SearchDocuments(ctx context.Context, query *SearchQuery)` метод
  - [ ] 5.3.2 Поддержка пагинации результатов
  - [ ] 5.3.3 Сортировка результатов по разным критериям
  - [ ] 5.3.4 Агрегация и фильтрация результатов

### 6. Управление транзакциями

- [ ] 6.1 Транзакционная целостность
  - [ ] 6.1.1 Использование ACID транзакций
  - [ ] 6.1.2 Обработка deadlock ситуаций
  - [ ] 6.1.3 Retry механизмы для транзакций
  - [ ] 6.1.4 Изоляция уровней транзакций

- [ ] 6.2 Batch операции
  - [ ] 6.2.1 Пакетная вставка документов
  - [ ] 6.2.2 Пакетное обновление индексов
  - [ ] 6.2.3 Оптимизация размера пакетов
  - [ ] 6.2.4 Обработка ошибок в пакетных операциях

### 7. Обработка ошибок и восстановление

- [ ] 7.1 Логирование ошибок
  - [ ] 7.1.1 Сохранение информации об ошибках в `processing_errors`
  - [ ] 7.1.2 Классификация ошибок по типам
  - [ ] 7.1.3 Сохранение stack trace для отладки
  - [ ] 7.1.4 Агрегация статистики ошибок

- [ ] 7.2 Механизмы восстановления
  - [ ] 7.2.1 Автоматический retry для временных ошибок
  - [ ] 7.2.2 Восстановление после разрыва соединения
  - [ ] 7.2.3 Проверка целостности данных
  - [ ] 7.2.4 Ручные инструменты для восстановления

### 8. Оптимизация производительности

- [ ] 8.1 Оптимизация запросов
  - [ ] 8.1.1 Анализ и оптимизация медленных запросов
  - [ ] 8.1.2 Использование EXPLAIN ANALYZE
  - [ ] 8.1.3 Оптимизация индексов
  - [ ] 8.1.4 Кэширование частых запросов

- [ ] 8.2 Управление ресурсами
  - [ ] 8.2.1 Оптимизация пула соединений
  - [ ] 8.2.2 Контроль использования памяти
  - [ ] 8.2.3 Мониторинг загрузки БД
  - [ ] 8.2.4 Оптимизация записи больших объемов данных

### 9. Конфигурация базы данных

- [ ] 9.1 Структура конфигурации
  - [ ] 9.1.1 Создать YAML структуру для настройки БД
  - [ ] 9.1.2 Параметры подключения (host, port, name, user, password)
  - [ ] 9.1.3 Настройки пула соединений
  - [ ] 9.1.4 Настройки SSL и безопасности

- [ ] 9.2 Управление конфигурацией
  - [ ] 9.2.1 Поддержка переменных окружения
  - [ ] 9.2.2 Валидация конфигурации
  - [ ] 9.2.3 Горячая перезагрузка конфигурации
  - [ ] 9.2.4 Профили конфигурации (dev, prod, test)

### 10. Мониторинг и метрики

- [ ] 10.1 Сбор метрик производительности
  - [ ] 10.1.1 Скорость индексации (документов/секунду)
  - [ ] 10.1.2 Размер базы данных
  - [ ] 10.1.3 Время выполнения поисковых запросов
  - [ ] 10.1.4 Количество ошибок индексации

- [ ] 10.2 Prometheus метрики
  - [ ] 10.2.1 Создать PrometheusCollector для БД метрик
  - [ ] 10.2.2 Метрики количества документов в БД
  - [ ] 10.2.3 Метрики времени ответа БД
  - [ ] 10.2.4 Метрики ошибок подключения

- [ ] 10.3 Health checks
  - [ ] 10.3.1 Проверка доступности БД
  - [ ] 10.3.2 Проверка производительности запросов
  - [ ] 10.3.3 Мониторинг размера таблиц
  - [ ] 10.3.4 Проверка целостности индексов

### 11. Резервное копирование и восстановление

- [ ] 11.1 Резервное копирование
  - [ ] 11.1.1 Автоматическое создание бэкапов
  - [ ] 11.1.2 Инкрементальные бэкапы
  - [ ] 11.1.3 Сжатие и хранение бэкапов
  - [ ] 11.1.4 Проверка целостности бэкапов

- [ ] 11.2 Восстановление
  - [ ] 11.2.1 Процедуры восстановления из бэкапов
  - [ ] 11.2.2 Тестирование восстановления
  - [ ] 11.2.3 Minimizing downtime при восстановлении
  - [ ] 11.2.4 Валидация данных после восстановления

### 12. Управление версиями и миграции

- [ ] 12.1 Система миграций
  - [ ] 12.1.1 Интеграция с golang-migrate
  - [ ] 12.1.2 Версионирование схемы БД
  - [ ] 12.1.3 Автоматическое применение миграций
  - [ ] 12.1.4 Откат миграций

- [ ] 12.2 Управление изменениями
  - [ ] 12.2.1 Процесс внесения изменений в схему
  - [ ] 12.2.2 Тестирование миграций
  - [ ] 12.2.3 Совместимость с предыдущими версиями
  - [ ] 12.2.4 Документация изменений

### 13. Тестирование

- [ ] 13.1 Unit тесты
  - [ ] 13.1.1 Тестирование CRUD операций
  - [ ] 13.1.2 Тестирование поиска
  - [ ] 13.1.3 Тестирование транзакций
  - [ ] 13.1.4 Тестирование обработки ошибок

- [ ] 13.2 Integration тесты
  - [ ] 13.2.1 Тестирование с реальной базой данных
  - [ ] 13.2.2 Тестирование производительности
  - [ ] 13.2.3 Тестирование конкурентного доступа
  - [ ] 13.2.4 Тестирование миграций

- [ ] 13.3 Нагрузочное тестирование
  - [ ] 13.3.1 Индексация 1000 документов
  - [ ] 13.3.2 Поиск в базе из 100000 документов
  - [ ] 13.3.3 Параллельная индексация
  - [ ] 13.3.4 Стресс тестирование

### 14. Безопасность

- [ ] 14.1 Безопасность данных
  - [ ] 14.1.1 Шифрование соединений с БД
  - [ ] 14.1.2 Управление доступом на уровне БД
  - [ ] 14.1.3 Аудит операций с данными
  - [ ] 14.1.4 Защита от SQL инъекций

- [ ] 14.2 Безопасность приложения
  - [ ] 14.2.1 Безопасное хранение паролей
  - [ ] 14.2.2 Валидация входных данных
  - [ ] 14.2.3 Ограничение прав приложения
  - [ ] 14.2.4 Мониторинг безопасности

### 15. Масштабирование

- [ ] 15.1 Вертикальное масштабирование
  - [ ] 15.1.1 Оптимизация использования ресурсов
  - [ ] 15.1.2 Настройка параметров PostgreSQL
  - [ ] 15.1.3 Мониторинг производительности
  - [ ] 15.1.4 Планирование ресурсов

- [ ] 15.2 Горизонтальное масштабирование
  - [ ] 15.2.1 Репликация базы данных
  - [ ] 15.2.2 Балансировка нагрузки чтения
  - [ ] 15.2.3 Разделение данных (sharding)
  - [ ] 15.2.4 Кэширование на разных уровнях

### 16. Документация

- [ ] 16.1 Внутренняя документация
  - [ ] 16.1.1 Комментарии ко всем функциям и структурам
  - [ ] 16.1.2 Описание схемы базы данных
  - [ ] 16.1.3 Примеры использования API
  - [ ] 16.1.4 Руководство по миграциям

- [ ] 16.2 Пользовательская документация
  - [ ] 16.2.1 Руководство по настройке БД
  - [ ] 16.2.2 Описание API поиска
  - [ ] 16.2.3 Troubleshooting guide
  - [ ] 16.2.4 Best practices для производительности

## Приоритеты

### Высокий приоритет (Phase 1)
- Пункты 1-4: Настройка, проектирование БД и базовый функционал
- Пункт 5: Реализация поиска
- Пункты 6-7: Транзакции и обработка ошибок

### Средний приоритет (Phase 2)
- Пункты 8-10: Оптимизация, конфигурация и мониторинг
- Пункты 11-12: Резервное копирование и миграции
- Пункт 14: Безопасность

### Низкий приоритет (Phase 3)
- Пункты 13, 15-16: Тестирование, масштабирование и документация

## Критерии готовности

- [ ] Схема базы данных спроектирована и реализована
- [ ] Все CRUD операции работают корректно
- [ ] Полнотекстовый поиск работает с русским языком
- [ ] Время индексации документа < 1 секунда
- [ ] Время поиска по индексу < 100ms
- [ ] Поддерживается до 1 000 000 документов
- [ ] ACID транзакции обеспечивают целостность данных
- [ ] Система восстановления после сбоев работает
- [ ] Все тесты проходят успешно
- [ ] Документация полна и понятна
- [ ] Метрики производительности собираются
- [ ] Резервное копирование настроено и протестировано