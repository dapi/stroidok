# План имплементации: Парсинг документов

## Обзор
План имплементации компонента парсинга документов для извлечения текстового содержимого и метаданных из файлов различных форматов (PDF, DOCX, XLSX, TXT).

## План имплементации

### 1. Настройка проекта и зависимостей

- [ ] 1.1 Установка зависимостей для парсинга
  - [ ] 1.1.1 `github.com/ledongthuc/pdf` - PDF парсинг
  - [ ] 1.1.2 `github.com/sajari/docx` - DOCX парсинг
  - [ ] 1.1.3 `github.com/tealeg/xlsx/v3` - XLSX парсинг
  - [ ] 1.1.4 `golang.org/x/text` - работа с кодировками
  - [ ] 1.1.5 `github.com/spf13/viper` - конфигурация
  - [ ] 1.1.6 `github.com/google/uuid` - генерация ID документов

- [ ] 1.2 Создание структуры проекта
  - [ ] 1.2.1 Создать `internal/parsing/` директорию
  - [ ] 1.2.2 Создать `internal/parsing/types.go` для типов и структур
  - [ ] 1.2.3 Создать `internal/parsing/config.go` для конфигурации
  - [ ] 1.2.4 Создать поддиректории для каждого формата: `pdf/`, `docx/`, `xlsx/`, `txt/`

### 2. Базовые структуры и интерфейсы

- [ ] 2.1 Основные структуры данных
  - [ ] 2.1.1 Создать `Document struct` с полями (Path, FileName, FileType, Size, Content, Metadata, Pages, Sheets)
  - [ ] 2.1.2 Создать `Page struct` для PDF документов
  - [ ] 2.1.3 Создать `Sheet struct` для XLSX документов
  - [ ] 2.1.4 Создать `Metadata struct` для унифицированных метаданных

- [ ] 2.2 Интерфейсы
  - [ ] 2.2.1 Создать `DocumentParser interface` с методами ParseDocument, SupportedExtensions, ValidateFile
  - [ ] 2.2.2 Создать `MetadataExtractor interface` для извлечения метаданных
  - [ ] 2.2.3 Создать `ContentValidator interface` для валидации контента
  - [ ] 2.2.4 Создать `ParserRegistry interface` для управления парсерами

### 3. Реализация PDF парсера

- [ ] 3.1 Базовая структура PDF парсера
  - [ ] 3.1.1 Создать `PDFParser struct` с настройками (maxFileSize, extractImages, preserveLayout)
  - [ ] 3.1.2 Реализовать конструктор `NewPDFParser(config *PDFConfig)`
  - [ ] 3.1.3 Реализовать `SupportedExtensions()` метод
  - [ ] 3.1.4 Реализовать `ValidateFile(path string)` метод

- [ ] 3.2 Извлечение текста из PDF
  - [ ] 3.2.1 Открытие PDF файла через github.com/ledongthuc/pdf
  - [ ] 3.2.2 Проверка пароля (если требуется)
  - [ ] 3.2.3 Извлечение текста страница за страницей
  - [ ] 3.2.4 Обработка кодировки и специальных символов
  - [ ] 3.2.5 Сохранение структуры документа (абзацы, списки)

- [ ] 3.3 Извлечение метаданных PDF
  - [ ] 3.3.1 Извлечение базовых метаданных (количество страниц, автор, заголовок)
  - [ ] 3.3.2 Извлечение creation/modification dates
  - [ ] 3.3.3 Обработка PDF версии и формата
  - [ ] 3.3.4 Извлечение информации о безопасности

- [ ] 3.4 Обработка ошибок PDF
  - [ ] 3.4.1 Обработка поврежденных PDF файлов
  - [ ] 3.4.2 Обработка файлов с паролями
  - [ ] 3.4.3 Обработка неподдерживаемых версий PDF
  - [ ] 3.4.4 Обработка файлов с нестандартной кодировкой

### 4. Реализация DOCX парсера

- [ ] 4.1 Базовая структура DOCX парсера
  - [ ] 4.1.1 Создать `DOCXParser struct` с настройками (extractStyles, preserveFormatting)
  - [ ] 4.1.2 Реализовать конструктор `NewDOCXParser(config *DOCXConfig)`
  - [ ] 4.1.3 Реализовать базовые интерфейсные методы
  - [ ] 4.1.4 Добавить валидацию ZIP архива

- [ ] 4.2 Извлечение текста из DOCX
  - [ ] 4.2.1 Распаковка DOCX архива в память
  - [ ] 4.2.2 Парсинг document.xml для основного контента
  - [ ] 4.2.3 Извлечение текста с сохранением абзацев
  - [ ] 4.2.4 Обработка заголовков и списков
  - [ ] 4.2.5 Сохранение базового форматирования (если требуется)

- [ ] 4.3 Извлечение метаданных DOCX
  - [ ] 4.3.1 Парсинг core.xml для базовых метаданных
  - [ ] 4.3.2 Извлечение автора, темы, ключевых слов
  - [ ] 4.3.3 Извлечение даты создания и изменения
  - [ ] 4.3.4 Обработка свойств документа

- [ ] 4.4 Обработка сложных DOCX
  - [ ] 4.4.1 Обработка документов с изображениями
  - [ ] 4.4.2 Обработка таблиц и колонтитулов
  - [ ] 4.4.3 Обработка сносок и комментариев
  - [ ] 4.4.4 Обработка вложенных документов

### 5. Реализация XLSX парсера

- [ ] 5.1 Базовая структура XLSX парсера
  - [ ] 5.1.1 Создать `XLSXParser struct` с настройками (maxRows, includeEmptyCells)
  - [ ] 5.1.2 Реализовать конструктор `NewXLSXParser(config *XLSXConfig)`
  - [ ] 5.1.3 Реализовать базовые интерфейсные методы
  - [ ] 5.1.4 Добавить валидацию файла Excel

- [ ] 5.2 Извлечение данных из XLSX
  - [ ] 5.2.1 Открытие рабочей книги через github.com/tealeg/xlsx/v3
  - [ ] 5.2.2 Определение активных листов
  - [ ] 5.2.3 Чтение данных построчно
  - [ ] 5.2.4 Обработка типов данных (числа, даты, текст)
  - [ ] 5.2.5 Формирование структурированного контента

- [ ] 5.3 Структурирование XLSX данных
  - [ ] 5.3.1 Создание Sheet структур для каждого листа
  - [ ] 5.3.2 Сохранение названий листов
  - [ ] 5.3.3 Подсчет количества строк и колонок
  - [ ] 5.3.4 Формирование текстового представления таблиц

- [ ] 5.4 Извлечение метаданных XLSX
  - [ ] 5.4.1 Извлечение количества листов
  - [ ] 5.4.2 Извлечение названий листов
  - [ ] 5.4.3 Извлечение информации о создателе
  - [ ] 5.4.4 Извлечение дат создания и изменения

### 6. Реализация TXT парсера

- [ ] 6.1 Базовая структура TXT парсера
  - [ ] 6.1.1 Создать `TXTParser struct` с настройками (encodingDetection, maxFileSize)
  - [ ] 6.1.2 Реализовать конструктор `NewTXTParser(config *TXTConfig)`
  - [ ] 6.1.3 Реализовать базовые интерфейсные методы
  - [ ] 6.1.4 Добавить проверку размера файла

- [ ] 6.2 Обработка кодировок
  - [ ] 6.2.1 Автоматическое определение кодировки файла
  - [ ] 6.2.2 Поддержка UTF-8, Windows-1251, ISO-8859-1
  - [ ] 6.2.3 Конвертация в UTF-8
  - [ ] 6.2.4 Обработка BOM (Byte Order Mark)

- [ ] 6.3 Чтение текстового контента
  - [ ] 6.3.1 Потоковое чтение больших файлов
  - [ ] 6.3.2 Обработка переносов строк
  - [ ] 6.3.3 Сохранение структуры абзацев
  - [ ] 6.3.4 Обработка специальных символов

### 7. Реализация Parser Registry

- [ ] 7.1 Реестр парсеров
  - [ ] 7.1.1 Создать `ParserRegistry struct` с map парсеров
  - [ ] 7.1.2 Реализовать методы RegisterParser и GetParser
  - [ ] 7.1.3 Автоматическая регистрация всех парсеров
  - [ ] 7.1.4 Валидация уникальности расширений

- [ ] 7.2 Фабрика парсеров
  - [ ] 7.2.1 Создать `ParserFactory` для создания парсеров
  - [ ] 7.2.2 Реализовать `NewParser(fileType string)` метод
  - [ ] 7.2.3 Реализовать `DetectFileType(path string)` метод
  - [ ] 7.2.4 Обработка неизвестных форматов

### 8. Валидация контента

- [ ] 8.1 Валидация документов
  - [ ] 8.1.1 Проверка минимального количества текстового контента (> 10 символов)
  - [ ] 8.1.2 Проверка отсутствия бинарных данных в текстовом потоке
  - [ ] 8.1.3 Валидация корректности кодировки UTF-8
  - [ ] 8.1.4 Проверка на пустые или поврежденные документы

- [ ] 8.2 Качество контента
  - [ ] 8.2.1 Проверка на читаемость текста
  - [ ] 8.2.2 Фильтрация мусорных символов
  - [ ] 8.2.3 Нормализация пробельных символов
  - [ ] 8.2.4 Проверка структуры документа

### 9. Обработка ошибок парсинга

- [ ] 9.1 Типы ошибок
  - [ ] 9.1.1 Создать `ParseError struct` с детальной информацией
  - [ ] 9.1.2 Создать типы ошибок для разных сценариев
  - [ ] 9.1.3 Реализовать методы для error interface
  - [ ] 9.1.4 Добавить stack trace для отладки

- [ ] 9.2 Обработка специфических ошибок
  - [ ] 9.2.1 Обработка поврежденных файлов
  - [ ] 9.2.2 Обработка файлов с паролями
  - [ ] 9.2.3 Обработка файлов неподдерживаемых версий
  - [ ] 9.2.4 Обработка ошибок ввода/вывода

### 10. Конфигурация парсеров

- [ ] 10.1 Структура конфигурации
  - [ ] 10.1.1 Создать YAML структуру конфигурации для каждого формата
  - [ ] 10.1.2 Добавить настройки производительности
  - [ ] 10.1.3 Добавить настройки качества извлечения
  - [ ] 10.1.4 Создать профили конфигурации (быстрый, качественный)

- [ ] 10.2 Управление конфигурацией
  - [ ] 10.2.1 Загрузка конфигурации из файла
  - [ ] 10.2.2 Валидация конфигурационных параметров
  - [ ] 10.2.3 Значения по умолчанию для каждого формата
  - [ ] 10.2.4 Обновление конфигурации во время выполнения

### 11. Кэширование и оптимизация

- [ ] 11.1 Кэширование результатов
  - [ ] 11.1.1 Кэширование распарсенных документов
  - [ ] 11.1.2 Кэширование на основе хэша файла
  - [ ] 11.1.3 Очистка устаревшего кэша
  - [ ] 11.1.4 Persistent кэш между запусками

- [ ] 11.2 Оптимизация производительности
  - [ ] 11.2.1 Потоковая обработка больших файлов
  - [ ] 11.2.2 Оптимизация использования памяти (< 100MB)
  - [ ] 11.2.3 Параллельная обработка документов
  - [ ] 11.2.4 Профилирование и устранение узких мест

### 12. Метрики и мониторинг

- [ ] 12.1 Сбор метрик
  - [ ] 12.1.1 Время обработки по форматам
  - [ ] 12.1.2 Точность извлечения текста
  - [ ] 12.1.3 Количество ошибок парсинга
  - [ ] 12.1.4 Размер извлеченного контента

- [ ] 12.2 Prometheus метрики
  - [ ] 12.2.1 Histogram для времени парсинга
  - [ ] 12.2.2 Counter для успешных/неудачных парсингов
  - [ ] 12.2.3 Gauge для размера контента
  - [ ] 12.2.4 Counter для ошибок по типам

### 13. Логирование

- [ ] 13.1 Структурированное логирование
  - [ ] 13.1.1 Логирование начала и окончания парсинга
  - [ ] 13.1.2 Логирование ошибок с детальной информацией
  - [ ] 13.1.3 Логирование производительности
  - [ ] 13.1.4 Логирование метаданных документов

- [ ] 13.2 Уровни детализации
  - [ ] 13.2.1 Debug: детальная информация о процессе парсинга
  - [ ] 13.2.2 Info: основные события и результаты
  - [ ] 13.2.3 Warn: некритические проблемы
  - [ ] 13.2.4 Error: ошибки парсинга

### 14. Тестирование

- [ ] 14.1 Unit тесты
  - [ ] 14.1.1 Тестирование парсинга каждого формата
  - [ ] 14.1.2 Тестирование извлечения метаданных
  - [ ] 14.1.3 Тестирование обработки ошибок
  - [ ] 14.1.4 Тестирование на пограничных значениях

- [ ] 14.2 Integration тесты
  - [ ] 14.2.1 Тестирование на реальных документах
  - [ ] 14.2.2 Тестирование производительности
  - [ ] 14.2.3 Тестирование на поврежденных файлах
  - [ ] 14.2.4 Тестирование на файлах с разными кодировками

- [ ] 14.3 Тестовые данные
  - [ ] 14.3.1 Создание `test-docs/` директории с образцами
  - [ ] 14.3.2 PDF: simple.pdf, complex.pdf, password-protected.pdf
  - [ ] 14.3.3 DOCX: simple.docx, formatted.docx, with-images.docx
  - [ ] 14.3.4 XLSX: simple.xlsx, multi-sheet.xlsx, large-data.xlsx
  - [ ] 14.3.5 TXT: utf-8.txt, windows-1251.txt, large-file.txt

### 15. Безопасность

- [ ] 15.1 Валидация входных данных
  - [ ] 15.1.1 Проверка размера файлов (лимит 100MB)
  - [ ] 15.1.2 Проверка путей файлов (path traversal)
  - [ ] 15.1.3 Валидация форматов файлов
  - [ ] 15.1.4 Проверка на вредоносный контент

- [ ] 15.2 Изоляция процессов
  - [ ] 15.2.1 Ограничение использования памяти
  - [ ] 15.2.2 Ограничение времени парсинга
  - [ ] 15.2.3 Обработка прерываний
  - [ ] 15.2.4 Graceful recovery после ошибок

### 16. Документация

- [ ] 16.1 Внутренняя документация
  - [ ] 16.1.1 Комментарии ко всем функциям и структурам
  - [ ] 16.1.2 Примеры использования API
  - [ ] 16.1.3 Описание алгоритмов парсинга
  - [ ] 16.1.4 Руководство по добавлению новых форматов

- [ ] 16.2 Пользовательская документация
  - [ ] 16.2.1 Поддерживаемые форматы и их особенности
  - [ ] 16.2.2 Рекомендации по подготовке документов
  - [ ] 16.2.3 Troubleshooting guide
  - [ ] 16.2.4 Best practices для оптимизации

## Приоритеты

### Высокий приоритет (Phase 1)
- Пункты 1-2: Настройка проекта и базовые структуры
- Пункты 3-6: Реализация парсеров для всех форматов
- Пункт 7: Parser Registry
- Пункт 9: Обработка ошибок

### Средний приоритет (Phase 2)
- Пункты 8, 10: Валидация и конфигурация
- Пункты 11-13: Оптимизация, метрики и логирование
- Пункт 15: Безопасность

### Низкий приоритет (Phase 3)
- Пункты 14, 16: Тестирование и документация

## Критерии готовности

- [ ] Все форматы (PDF, DOCX, XLSX, TXT) поддерживаются
- [ ] Точность извлечения текста > 95%
- [ ] Время обработки файла < 5 секунд для файлов до 50MB
- [ ] Потребление памяти < 100MB для файлов до 100MB
- [ ] Параллельная обработка до 10 файлов одновременно
- [ ] Корректная обработка ошибок для всех сценариев
- [ ] Валидация контента работает для всех форматов
- [ ] Метаданные извлекаются корректно
- [ ] Все тесты проходят успешно
- [ ] Документация полна и понятна