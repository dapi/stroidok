# Интеграция с Claude Code

## Как Claude Code определяет релевантность MCP-вызовов

> **Терминология:** Все используемые термины определены в [`./glossary.md`](./glossary.md)

### 1. Анализ пользовательского запроса
Claude анализирует запрос и определяет, что ему нужна внешняя информация:
```
Пользователь: "Какие требования к безопасности в нашем проекте?"
Claude понимает: нужно искать в документах проекта
```

### 2. Available Tools (доступные инструменты)
Когда MCP-сервер подключен, он "объявляет" свои инструменты:
```json
{
  "tools": [
    {
      "name": "search_documents",
      "description": "Search through project documents",
      "parameters": {
        "query": "string describing what to search for"
      }
    }
  ]
}
```

### 3. Semantic Matching (семантическое сопоставление)
Claude сопоставляет:
- **Запрос пользователя** ↔ **Описание инструмента**
- **Контекст запроса** ↔ **Возможности инструмента**

**Пример:**
```
Запрос: "Покажи бюджет постройки дома"
↓
Доступные инструменты:
- search_documents (поиск в документах)
- get_file_content (чтение файлов)
↓
Решение: использовать search_documents с query="бюджет постройки дома"
```

### 4. Контекстуальные триггеры
Claude вызывает MCP-инструменты когда пользователь:
- Упоминает документы/файлы/проектную информацию
- Просит найти что-то в документации
- Спрашивает о конкретных данных из проекта
- Нуждается в актуальной информации из файлов

### 5. Примеры реальных сценариев:

**Будет вызывать MCP:**
```
"Что в техническом задании про архитектуру?"
"Найди все упоминания API в документах"
"Какие у нас требования к тестированию?"
```

**Не будет вызывать MCP:**
```
"Напиши функцию на Python"
"Объясни принцип работы REST API"
"Как оптимизировать SQL запрос?"
```

## Варианты интеграции с Claude Code

### 1. MCP-сервер интеграция
- Реализация MCP-сервера для подключения к Claude Code
- Предоставление инструментов поиска по документам
- Автоматическое обогащение контекста релевантными документами
- Text-to-SQL запросы для точного поиска информации

### 2. Anthropic SDK интеграция

#### Python SDK:
```python
from anthropic import Anthropic

client = Anthropic(api_key="your-api-key")
response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=1024,
    messages=[
        {"role": "user", "content": f"Вопрос: {query}\n\nКонтекст из документов:\n{retrieved_docs}"}
    ]
)
```

#### TypeScript SDK:
```typescript
import Anthropic from '@anthropic-ai/sdk';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

const response = await anthropic.messages.create({
  model: 'claude-3-5-sonnet-20241022',
  max_tokens: 1024,
  messages: [{
    role: 'user',
    content: `Вопрос: ${query}\n\nКонтекст из документов:\n${retrievedDocs}`
  }]
});
```

### 3. CLI интеграция через pipe
```bash
# Пример использования в Claude Code
docsearch "вопрос по документам" | claude-code --context-from-stdin
```

### 4. Прямая API интеграция
- REST API endpoints для поиска документов
- WebSocket для real-time обновлений
- Асинхронная обработка запросов

## Сценарии использования

### 1. Явный запрос контекста
Пользователь использует slash команды для поиска документов:
```
/search "вопрос по проектной документации"
/docs "технические требования к API"
```

### 2. MCP-инструменты
Claude Code использует инструменты MCP-сервера по запросу:
- `search_documents` - поиск по документам
- `get_document_content` - получение содержимого документа
- `list_recent_changes` - последние изменения в документах

### 3. Фоновое индексирование
Система постоянно обновляет индекс документов

### 4. Гибридный подход
Комбинация явных запросов и MCP-инструментов

## Механизмы интеграции

### Через MCP-сервер:
- Claude Code может вызывать функции MCP-сервера при обработке запросов
- Пользователь может явно попросить: "Найди в проектной документации информацию о..."
- Система предоставляет инструменты, которые Claude использует по необходимости

### Через CLI:
```bash
# Явный поиск перед использованием Claude Code
docsearch "требования к безопасности" > context.txt
claude-code --context-file context.txt "Проанализируй требования к безопасности"
```

## Ключевой принцип

Claude не "знает" заранее что вызывать. Он **анализирует каждый запрос** и решает в реальном времени, нужен ли ему доступ к внешним инструментам. Это похоже на то, как человек решает - заглянуть в справочник или ответить по памяти.

Поэтому важно, чтобы MCP-сервер предоставлял **четкие описания** своих инструментов - именно на их основе Claude принимает решение о вызове.